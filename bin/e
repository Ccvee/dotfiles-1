#!/usr/bin/env bash

# e
#
# Automatically determine whether to use vim or gvim and use a single instance
#
# Copyright (c) 2015 David O'Trakoun <me@davidosomething.com>
#

_e() {
  local executable
  local servername
  local args
  local files

  # which executable -----------------------------------------------------------
  # In SSH
  if [[ -n "$SSH_CONNECTION" ]]; then
    executable="vim"
    servername="VIM"

  # Linux without X11
  elif [[ "$DOTFILES_OS" == "Linux" ]] && [[ -z "$DISPLAY" ]]; then
    executable="vim"
    servername="VIM"

  else
    executable="gvim"
    servername="GVIM"
  fi

  # arg parsing ----------------------------------------------------------------

  args="--servername $servername"
  if [ $# -ne 0 ]; then
    files=""
    while [ "$1" != "" ]; do
      if [[ "$1" == --* ]]; then
        args="$args $1"
      else
        files="$files $1"
      fi
      shift
    done

    if [ "$files" != "" ]; then
      args="$args --remote-silent"
    fi

    # shellcheck disable=SC2086
    # remote silent will FG the vim server
    $executable $args $files

  # no args, just foregroud existing server
  elif $executable --serverlist | grep GVIM >/dev/null 2>&1; then
    # shellcheck disable=SC2086
    $executable $args --remote-send ":<Silent>call foreground()<CR>"

  # no args, NEW SERVER
  else
    # shellcheck disable=SC2086
    $executable $args
  fi

  exit 0
}

_e "${@}"

