#!/usr/bin/env bash

# e
#
# Automatically determine whether to use vim or gvim and use a single instance
#
# Copyright (c) 2015 David O'Trakoun <me@davidosomething.com>
#

_e() {
  local executable
  local has_server
  local server
  local servername
  local args
  local files

  # which executable -----------------------------------------------------------
  # In SSH
  if [[ -n "$SSH_CONNECTION" ]]; then
    executable="vim"
    servername="VIM"

  # Linux without X11
  elif [[ "$DOTFILES_OS" == "Linux" ]] && [[ -z "$DISPLAY" ]]; then
    executable="vim"
    servername="VIM"

  else
    executable="gvim"
    servername="GVIM"
  fi

  # arg parsing ----------------------------------------------------------------

  if [ $# -ne 0 ]; then
    files=""
    while [ "$1" != "" ]; do
      if [[ "$1" == --* ]]; then
        args="$args $1"
      else
        [[ "$1" == *"COMMIT_EDITMSG" ]] && servername="GIT"
        files="$files $1"
      fi
      shift
    done
  fi

  has_server=$( { $executable --serverlist | grep -n1 $servername; } 2>&1 )
  server="--servername $servername"

  # reuse server
  if [ "$has_server" != "" ]; then
    if [ "$files" = "" ]; then
      # shellcheck disable=SC2089
      args="$args --remote-send \":call foreground()<CR>\""
    else
      args="$args --remote-silent"
    fi
  fi

  # shellcheck disable=SC2086,SC2090
  $executable $server $args $files
}

_e "${@}"

